{% load url from future %}
{% load static %}
{% load templateextras %}
{% load match_center_tags %}
{% get_static_prefix as STATIC_URL %}

<!DOCTYPE html>
<html lang="en">

<head>

    <title>{% block title %}Ä°statistik | istatistik.ligtv.com.tr{% endblock %}</title>

    {% include '_vs_headincludes.html' %}

    <script type="text/javascript">
        $(function() {
            startRefresh();
        });

        function startRefresh() {
            setTimeout(startRefresh,30000);
            $.ajax({ url: "/new/partial/score/{{ selectedMatch }}/",
                success: function(d){
                    $("#homeTeamScore").html(d.home);
                    $("#awayTeamScore").html(d.away);
                    $("#sb-match-time-p").html(d.mminute+"'");
                }});

        }
    </script>

    {% block head-addition %}

    {% endblock %}

</head>

<body>

<div id="global-header">
    {% include '_vs_scoreboard.html' with matchInfo=matchInfo only %}
</div>

<div id="content">
    <div id="sidebar">
        {% sl_fixture selectedMatch %}
        {% include '_vs_goalvideo.html' with goals=goals teamColors=teamColors homeTeamId=homeTeamId awayTeamId=awayTeamId  only %}

        <div id="sidestats-container">
            {% include '_vs_sidestats.html' with matchData=matchData teamColors=teamColors homeTeamId=homeTeamId awayTeamId=awayTeamId only %}
        </div>
    </div>
    <div id="main">
        <div id="menu">
            {% block menu %}{% endblock %}
        </div>
        <div id="content">
            {% block content %}{% endblock %}
        </div>
    </div>

</div>

<div id="footer"></div>
<script src="{{ STATIC_URL }}js/knockout-2.3.0.js"></script>
<script>
    var csrftoken = $.cookie('csrftoken');
    $.ajaxSetup({
        crossDomain: false,
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    });

    // fades in or fades out the element depending on the value of the logical comparison
    ko.bindingHandlers.fadeVisible = {
        init: function(element, valueAccessor) {
            // Start visible/invisible according to initial value
            var shouldDisplay = valueAccessor();
            $(element).toggle(shouldDisplay);
        },
        update: function(element, valueAccessor) {
            // On update, fade in/out
            var shouldDisplay = valueAccessor();
            shouldDisplay ? $(element).show() : $(element).hide();
        }
    };

    var FixtureModel = function() {
        var self = this;

        //stores weeks of the fixture
        self.weeks = ko.observableArray([
            {% for week in weeks|dictsort:"weekId" %}
                {week_id: "{{ week.weekId }}", week_status:"{{ week.status }}"},
            {% endfor %}
        ]);

        //stores all matches in the fixture
        self.matches = ko.observableArray([
            {% for week in weeks|dictsort:"weekId" %}
                {% for match in week.matches|dictsort:"date" %}
                    {% if match.matchId == selectedMatch  %}
                        {weekId: "{{ week.weekId }}", weekStatus: "{{ week.status }}", matchId:"{{ match.matchId }}",matchStatus:"{{ match.matchStatus }}",homeTeam:"{{ match.homeTeam }}", homeTeamCond:"{{ match.homeTeamCond }}", homeTeamInt:"{{ match.homeTeamInt }}",awayTeam:"{{ match.awayTeam }}",awayTeamCond:"{{ match.awayTeamCond}}", awayTeamInt:"{{ match.awayTeamInt }}",homeTeamId:"{{ match.homeTeamId }}",awayTeamId:"{{ match.awayTeamId }}",homeScore:"{{ match.homeScore }}",awayScore:"{{ match.awayScore }}",date:"{{ match.date }}",liveTime:"{{ match.liveTime}}",referee:"{{ match.referee }}",stadium:"{{ match.stadium }}",matchClass:"match-selected"},
                    {% else %}
                        {weekId: "{{ week.weekId }}", weekStatus: "{{ week.status }}", matchId:"{{ match.matchId }}",matchStatus:"{{ match.matchStatus }}",homeTeam:"{{ match.homeTeam }}", homeTeamCond:"{{ match.homeTeamCond }}", homeTeamInt:"{{ match.homeTeamInt }}",awayTeam:"{{ match.awayTeam }}",awayTeamCond:"{{ match.awayTeamCond}}", awayTeamInt:"{{ match.awayTeamInt }}",homeTeamId:"{{ match.homeTeamId }}",awayTeamId:"{{ match.awayTeamId }}",homeScore:"{{ match.homeScore }}",awayScore:"{{ match.awayScore }}",date:"{{ match.date }}",liveTime:"{{ match.liveTime}}",referee:"{{ match.referee }}",stadium:"{{ match.stadium }}",matchClass:"match"},
                    {% endif %}
                {% endfor %}
            {% endfor %}
        ]);

        self.selectedWeek = ko.observable("{{ currentWeek }}");
        self.selectedMatch = ko.observable("{{ selectedMatch }}");

        //filters the matches for selected week
        self.matchesToShow = ko.computed(function() {
            // Represents a filtered list of matches
            var desiredWeek = this.selectedWeek();
            return ko.utils.arrayFilter(this.matches(), function(match) {
                return match.weekId.toLowerCase() == desiredWeek.toLowerCase();
            });
        }, this);

        self.playedMatches = ko.computed(function(){
            var desiredWeek = this.selectedWeek();
            return ko.utils.arrayFilter(this.matches(), function(match) {
                if(match.weekId.toLowerCase() == desiredWeek.toLowerCase() && (match.matchStatus == 6 || match.matchStatus == 11 || match.matchStatus == 13)){
                    return match;
                }
            });
        },this);

        self.liveMatches = ko.computed(function(){
            var desiredWeek = this.selectedWeek();
            return ko.utils.arrayFilter(this.matches(), function(match) {
                if(match.weekId.toLowerCase() == desiredWeek.toLowerCase() && (match.matchStatus != 6 && match.matchStatus != 11 && match.matchStatus != 13 && match.matchStatus != 1 && match.matchStatus != 5 && match.matchStatus != 17)){
                    return match;
                }
            });
        },this);

        self.notPlayedMatches = ko.computed(function(){
            var desiredWeek = this.selectedWeek();
            return ko.utils.arrayFilter(this.matches(), function(match) {
                if(match.weekId.toLowerCase() == desiredWeek.toLowerCase() && (match.matchStatus ==1)){
                    return match;
                }
            });
        },this);

        self.fixtureWidgetHeight = ko.computed(function(){
            var baseHeight = 310;
            if( self.playedMatches().length>0){
                baseHeight += 20;
            }
            if( self.notPlayedMatches.length>0){
                baseHeight += 20;
            }
            return baseHeight + "px";
        },this);


        // Selects 3 weeks to show, depending on the selected week
        self.weeksToShow = ko.computed(function() {
            // Represents a filtered list of weeks
            var desiredWeek = this.selectedWeek();
            return ko.utils.arrayFilter(this.weeks(), function(week) {
                // if first week return first 3 weeks
                if(parseInt(desiredWeek) == 1 && week.week_id<4){
                    return week.week_id;
                }
                // if last week return last 3 weeks
                if(parseInt(desiredWeek) == 34 && week.week_id>31){
                    return week.week_id;
                }
                // else return selected week with one before and one after
                if(week.week_id == parseInt(desiredWeek) + 1 | week.week_id == desiredWeek | week.week_id == parseInt(desiredWeek) - 1){
                    return week.week_id;
                }
            });
        }, this);

        self.autoRefresh = function(){
            ko.utils.arrayForEach(self.matches(), function(match) {
                if(parseInt(match.weekStatus) == 0 ){
                    $.post("/api/GetMatchInfo", JSON.stringify({"leagueId": {{ leagueId }}, "seasonId": {{seasonId}}, "matchId": match.matchId})).done(function(data){
                        match.homeScore = data.data[0][7];
                        match.awayScore = data.data[0][8];
                        match.liveTime = data.data[0][11];
                        match.matchStatus = data.data[0][2];
                        console.log(match.homeTeam + " - " + match.awayTeam + " match updated with; matchStatus:" + match.matchStatus + " homeScore:" + match.homeScore + " awayScore:" + match.awayScore + " liveTime:" + match.liveTime);
                    });
                }
            });
        };

        setInterval(self.autoRefresh,60000);

        // changes the selected week
        self.changeWeek = function(elem) {
            self.selectedWeek(elem.week_id);
        };

        // show and hide effects
        this.showMatch = function(elem) { if (elem.nodeType === 1) $(elem).hide().slideToggle() };
        this.hideMatch = function(elem) { if (elem.nodeType === 1) $(elem).slideToggle(function() { $(elem).remove(); }),1200 };
    };

    ko.applyBindings(new FixtureModel());
</script>

</body>

</html>